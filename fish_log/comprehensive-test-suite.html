<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Fish Log Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/beautiful-buttons.css">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result { 
            margin: 4px 0; 
            padding: 8px 12px; 
            border-radius: 4px; 
            font-family: monospace;
            font-size: 14px;
        }
        .test-pass { background-color: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .test-fail { background-color: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .test-warn { background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .test-info { background-color: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .test-running { background-color: #e2e3e5; color: #6c757d; border-left: 4px solid #6c757d; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        
        .test-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        .stat-total { background-color: #e9ecef; color: #495057; }
        .stat-pass { background-color: #d4edda; color: #155724; }
        .stat-fail { background-color: #f8d7da; color: #721c24; }
        .stat-warn { background-color: #fff3cd; color: #856404; }
        
        .collapsible-section {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin: 10px 0;
        }
        .collapsible-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-content {
            padding: 16px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .collapsible-content.active {
            display: block;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .floating-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .error-highlight {
            background-color: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            .floating-controls {
                position: static;
                flex-direction: row;
                justify-content: center;
                margin: 20px 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Floating Controls -->
    <div class="floating-controls">
        <button onclick="runFullTestSuite()" class="shiny-button ripple-effect bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-700">
            üöÄ Run All Tests
        </button>
        <button onclick="clearAllResults()" class="shiny-button ripple-effect bg-gray-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-700">
            üßπ Clear Results
        </button>
        <button onclick="exportTestResults()" class="shiny-button ripple-effect bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700">
            üì• Export Results
        </button>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üêü Fish Log Comprehensive Test Suite</h1>
            <p class="text-gray-600">Testing all functionality and error handlers</p>
            
            <!-- Overall Progress -->
            <div class="max-w-md mx-auto mt-6">
                <div class="progress-bar">
                    <div id="overall-progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="test-stats justify-center">
                    <div class="stat-item stat-total">Total: <span id="total-tests">0</span></div>
                    <div class="stat-item stat-pass">Pass: <span id="pass-tests">0</span></div>
                    <div class="stat-item stat-fail">Fail: <span id="fail-tests">0</span></div>
                    <div class="stat-item stat-warn">Warn: <span id="warn-tests">0</span></div>
                </div>
            </div>
        </header>

        <!-- Test Categories -->
        <div class="test-grid">
            <!-- Core Functionality Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üîß Core Functionality Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testCoreFunctionality()" class="shiny-button ripple-effect bg-blue-500 text-white px-4 py-2 rounded w-full">
                        Test Core Functions
                    </button>
                    <button onclick="testDOMElements()" class="shiny-button ripple-effect bg-indigo-500 text-white px-4 py-2 rounded w-full">
                        Test DOM Elements
                    </button>
                    <button onclick="testFormValidation()" class="shiny-button ripple-effect bg-purple-500 text-white px-4 py-2 rounded w-full">
                        Test Form Validation
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('core-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="core-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Error Handler Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üö® Error Handler Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testErrorHandler()" class="shiny-button ripple-effect bg-red-500 text-white px-4 py-2 rounded w-full">
                        Test Error Handling
                    </button>
                    <button onclick="testCustomErrors()" class="shiny-button ripple-effect bg-pink-500 text-white px-4 py-2 rounded w-full">
                        Test Custom Errors
                    </button>
                    <button onclick="testGlobalErrorHandling()" class="shiny-button ripple-effect bg-orange-500 text-white px-4 py-2 rounded w-full">
                        Test Global Errors
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('error-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="error-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Database Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üíæ Database Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testDatabaseOperations()" class="shiny-button ripple-effect bg-green-500 text-white px-4 py-2 rounded w-full">
                        Test CRUD Operations
                    </button>
                    <button onclick="testIndexedDB()" class="shiny-button ripple-effect bg-teal-500 text-white px-4 py-2 rounded w-full">
                        Test IndexedDB
                    </button>
                    <button onclick="testDataPersistence()" class="shiny-button ripple-effect bg-emerald-500 text-white px-4 py-2 rounded w-full">
                        Test Data Persistence
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('database-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="database-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Algorithm Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üß† Algorithm Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testWeightCalculation()" class="shiny-button ripple-effect bg-yellow-500 text-white px-4 py-2 rounded w-full">
                        Test Weight Calculation
                    </button>
                    <button onclick="testSelfImprovingAlgorithm()" class="shiny-button ripple-effect bg-amber-500 text-white px-4 py-2 rounded w-full">
                        Test Self-Improving Algorithm
                    </button>
                    <button onclick="testPatternLearning()" class="shiny-button ripple-effect bg-orange-400 text-white px-4 py-2 rounded w-full">
                        Test Pattern Learning
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('algorithm-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="algorithm-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- UI/UX Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üé® UI/UX Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testModalFunctionality()" class="shiny-button ripple-effect bg-violet-500 text-white px-4 py-2 rounded w-full">
                        Test Modals
                    </button>
                    <button onclick="testTabSystem()" class="shiny-button ripple-effect bg-purple-500 text-white px-4 py-2 rounded w-full">
                        Test Tab System
                    </button>
                    <button onclick="testThemeSystem()" class="shiny-button ripple-effect bg-indigo-500 text-white px-4 py-2 rounded w-full">
                        Test Theme System
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('ui-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="ui-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Location & Map Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üó∫Ô∏è Location & Map Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testLocationServices()" class="shiny-button ripple-effect bg-cyan-500 text-white px-4 py-2 rounded w-full">
                        Test Location Services
                    </button>
                    <button onclick="testMapFunctionality()" class="shiny-button ripple-effect bg-blue-500 text-white px-4 py-2 rounded w-full">
                        Test Map Features
                    </button>
                    <button onclick="testGeolocation()" class="shiny-button ripple-effect bg-sky-500 text-white px-4 py-2 rounded w-full">
                        Test Geolocation
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('location-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="location-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Photo & Media Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üì∏ Photo & Media Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testPhotoHandling()" class="shiny-button ripple-effect bg-rose-500 text-white px-4 py-2 rounded w-full">
                        Test Photo Upload
                    </button>
                    <button onclick="testImageProcessing()" class="shiny-button ripple-effect bg-pink-500 text-white px-4 py-2 rounded w-full">
                        Test Image Processing
                    </button>
                    <button onclick="testFullscreenImage()" class="shiny-button ripple-effect bg-fuchsia-500 text-white px-4 py-2 rounded w-full">
                        Test Fullscreen Image
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('photo-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="photo-results" class="collapsible-content"></div>
                </div>
            </div>

            <!-- Data Management Tests -->
            <div class="test-section bg-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üìä Data Management Tests
                </h2>
                <div class="space-y-2">
                    <button onclick="testDataExport()" class="shiny-button ripple-effect bg-lime-500 text-white px-4 py-2 rounded w-full">
                        Test Data Export
                    </button>
                    <button onclick="testDataImport()" class="shiny-button ripple-effect bg-green-500 text-white px-4 py-2 rounded w-full">
                        Test Data Import
                    </button>
                    <button onclick="testSpeciesManagement()" class="shiny-button ripple-effect bg-emerald-500 text-white px-4 py-2 rounded w-full">
                        Test Species Management
                    </button>
                </div>
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('data-results')">
                        Results <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="data-results" class="collapsible-content"></div>
                </div>
            </div>
        </div>

        <!-- Performance Tests -->
        <div class="test-section bg-white">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                ‚ö° Performance Tests
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testPerformanceMetrics()" class="shiny-button ripple-effect bg-gray-700 text-white px-4 py-2 rounded">
                    Test Performance Metrics
                </button>
                <button onclick="testMemoryUsage()" class="shiny-button ripple-effect bg-gray-600 text-white px-4 py-2 rounded">
                    Test Memory Usage
                </button>
                <button onclick="testLoadTimes()" class="shiny-button ripple-effect bg-gray-500 text-white px-4 py-2 rounded">
                    Test Load Times
                </button>
            </div>
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('performance-results')">
                    Results <span class="toggle-icon">‚ñº</span>
                </div>
                <div id="performance-results" class="collapsible-content"></div>
            </div>
        </div>

        <!-- Test Summary -->
        <div class="test-section bg-gray-800 text-white">
            <h2 class="text-xl font-semibold mb-4">üìã Test Summary</h2>
            <div id="test-summary" class="space-y-2">
                <p>No tests run yet. Click "Run All Tests" to begin comprehensive testing.</p>
            </div>
        </div>
    </div>

    <!-- Include necessary scripts -->
    <script src="js/errorHandler.js"></script>
    <script src="js/fishDatabase.js"></script>
    <script src="js/selfImprovingAlgorithm.js"></script>
    <script src="js/beautiful-buttons.js"></script>
    
    <script>
        // Test Framework Variables
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };
        let testResults = [];
        let isRunning = false;

        // Utility Functions
        function addResult(containerId, message, type = 'info', details = null) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result test-${type}`;
            
            let content = message;
            if (details) {
                content += `\n${details}`;
            }
            
            div.textContent = content;
            container.appendChild(div);
            
            // Update stats
            testStats.total++;
            if (type === 'pass') testStats.passed++;
            else if (type === 'fail') testStats.failed++;
            else if (type === 'warn') testStats.warnings++;
            
            updateTestStats();
            
            // Store result for export
            testResults.push({
                timestamp: new Date().toISOString(),
                category: containerId,
                message: message,
                type: type,
                details: details
            });
        }

        function updateTestStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('pass-tests').textContent = testStats.passed;
            document.getElementById('fail-tests').textContent = testStats.failed;
            document.getElementById('warn-tests').textContent = testStats.warnings;
            
            // Update progress bar
            const progressPercent = testStats.total > 0 ? (testStats.passed / testStats.total) * 100 : 0;
            document.getElementById('overall-progress').style.width = progressPercent + '%';
        }

        function clearResults(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        }

        function clearAllResults() {
            const resultContainers = [
                'core-results', 'error-results', 'database-results', 'algorithm-results',
                'ui-results', 'location-results', 'photo-results', 'data-results', 'performance-results'
            ];
            
            resultContainers.forEach(containerId => clearResults(containerId));
            
            // Reset stats
            testStats = { total: 0, passed: 0, failed: 0, warnings: 0 };
            testResults = [];
            updateTestStats();
            
            document.getElementById('test-summary').innerHTML = '<p>Results cleared. Ready for new tests.</p>';
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }

        // Test timeout wrapper
        function withTimeout(testFunction, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error('Test timed out'));
                }, timeout);
                
                Promise.resolve(testFunction())
                    .then(resolve)
                    .catch(reject)
                    .finally(() => clearTimeout(timeoutId));
            });
        }

        // Core Functionality Tests
        async function testCoreFunctionality() {
            clearResults('core-results');
            addResult('core-results', 'Testing core functionality...', 'running');
            
            try {
                // Test 1: Check if main app object exists
                if (typeof window.app !== 'undefined') {
                    addResult('core-results', '‚úì Main app object exists', 'pass');
                } else {
                    addResult('core-results', '‚úó Main app object missing', 'fail');
                }
                
                // Test 2: Check critical functions
                const criticalFunctions = [
                    'showCatchModal', 'showEditModal', 'loadCatchHistory', 
                    'saveCatch', 'deleteCatch', 'updateCatch'
                ];
                
                let functionsFound = 0;
                criticalFunctions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        addResult('core-results', `‚úì Function ${funcName} exists`, 'pass');
                        functionsFound++;
                    } else {
                        addResult('core-results', `‚úó Function ${funcName} missing`, 'fail');
                    }
                });
                
                // Test 3: Check localStorage availability
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    addResult('core-results', '‚úì localStorage available', 'pass');
                } catch (e) {
                    addResult('core-results', '‚úó localStorage unavailable', 'fail', e.message);
                }
                
                // Test 4: Check IndexedDB availability
                if ('indexedDB' in window) {
                    addResult('core-results', '‚úì IndexedDB available', 'pass');
                } else {
                    addResult('core-results', '‚úó IndexedDB unavailable', 'fail');
                }
                
                addResult('core-results', `Core functionality test complete. Functions found: ${functionsFound}/${criticalFunctions.length}`, 'info');
                
            } catch (error) {
                addResult('core-results', '‚úó Core functionality test failed', 'fail', error.message);
            }
        }

        async function testDOMElements() {
            clearResults('core-results');
            addResult('core-results', 'Testing DOM elements...', 'running');
            
            const requiredElements = [
                'catch-form', 'species', 'length', 'weight', 'datetime', 'notes',
                'catch-modal', 'edit-modal', 'map-modal', 'location-name-modal',
                'catch-log', 'history-tab-btn', 'records-tab-btn', 'map-tab-btn',
                'get-location-btn', 'photo-upload-btn', 'theme-toggle-btn'
            ];
            
            let elementsFound = 0;
            requiredElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    addResult('core-results', `‚úì Element #${elementId} exists`, 'pass');
                    elementsFound++;
                } else {
                    addResult('core-results', `‚úó Element #${elementId} missing`, 'fail');
                }
            });
            
            addResult('core-results', `DOM elements test complete. Found: ${elementsFound}/${requiredElements.length}`, 'info');
        }

        async function testFormValidation() {
            clearResults('core-results');
            addResult('core-results', 'Testing form validation...', 'running');
            
            try {
                const form = document.getElementById('catch-form');
                if (!form) {
                    addResult('core-results', '‚úó Catch form not found', 'fail');
                    return;
                }
                
                // Test required fields
                const requiredFields = ['species', 'datetime'];
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.required) {
                        addResult('core-results', `‚úì Field ${fieldId} is required`, 'pass');
                    } else {
                        addResult('core-results', `‚úó Field ${fieldId} not required or missing`, 'fail');
                    }
                });
                
                // Test numeric fields
                const numericFields = ['length', 'weight'];
                numericFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.type === 'number') {
                        addResult('core-results', `‚úì Field ${fieldId} is numeric`, 'pass');
                    } else {
                        addResult('core-results', `‚úó Field ${fieldId} not numeric or missing`, 'fail');
                    }
                });
                
                addResult('core-results', 'Form validation test complete', 'info');
                
            } catch (error) {
                addResult('core-results', '‚úó Form validation test failed', 'fail', error.message);
            }
        }

        // Error Handler Tests
        async function testErrorHandler() {
            clearResults('error-results');
            addResult('error-results', 'Testing error handler...', 'running');
            
            try {
                // Test 1: Check if error handler exists
                if (window.errorHandler) {
                    addResult('error-results', '‚úì Error handler initialized', 'pass');
                    
                    // Test 2: Test error logging
                    const testError = new Error('Test error');
                    window.errorHandler.logError(testError, 'TestContext');
                    addResult('error-results', '‚úì Error logging works', 'pass');
                    
                    // Test 3: Test error log retrieval
                    const errorLog = window.errorHandler.getErrorLog();
                    if (Array.isArray(errorLog)) {
                        addResult('error-results', `‚úì Error log retrieved (${errorLog.length} entries)`, 'pass');
                    } else {
                        addResult('error-results', '‚úó Error log not accessible', 'fail');
                    }
                    
                } else {
                    addResult('error-results', '‚úó Error handler not initialized', 'fail');
                }
                
                // Test 4: Test custom error classes
                const customErrors = [
                    'FishLogError', 'DatabaseError', 'StorageError', 
                    'CalculationError', 'ValidationError', 'NetworkError'
                ];
                
                customErrors.forEach(errorClass => {
                    if (window[errorClass]) {
                        addResult('error-results', `‚úì Custom error class ${errorClass} exists`, 'pass');
                    } else {
                        addResult('error-results', `‚úó Custom error class ${errorClass} missing`, 'fail');
                    }
                });
                
            } catch (error) {
                addResult('error-results', '‚úó Error handler test failed', 'fail', error.message);
            }
        }

        async function testCustomErrors() {
            clearResults('error-results');
            addResult('error-results', 'Testing custom error classes...', 'running');
            
            try {
                // Test FishLogError
                const fishLogError = new FishLogError('Test fish log error');
                if (fishLogError.name === 'FishLogError' && fishLogError.timestamp) {
                    addResult('error-results', '‚úì FishLogError works correctly', 'pass');
                } else {
                    addResult('error-results', '‚úó FishLogError not working', 'fail');
                }
                
                // Test DatabaseError
                const dbError = new DatabaseError('Test database error', null, 'CREATE');
                if (dbError.name === 'DatabaseError' && dbError.operation === 'CREATE') {
                    addResult('error-results', '‚úì DatabaseError works correctly', 'pass');
                } else {
                    addResult('error-results', '‚úó DatabaseError not working', 'fail');
                }
                
                // Test ValidationError
                const validationError = new ValidationError('Test validation error', 'species', 'invalid');
                if (validationError.name === 'ValidationError' && validationError.field === 'species') {
                    addResult('error-results', '‚úì ValidationError works correctly', 'pass');
                } else {
                    addResult('error-results', '‚úó ValidationError not working', 'fail');
                }
                
                addResult('error-results', 'Custom error classes test complete', 'info');
                
            } catch (error) {
                addResult('error-results', '‚úó Custom error test failed', 'fail', error.message);
            }
        }

        async function testGlobalErrorHandling() {
            clearResults('error-results');
            addResult('error-results', 'Testing global error handling...', 'running');
            
            try {
                // Test if global error handlers are set up
                let hasUnhandledRejectionHandler = false;
                let hasErrorHandler = false;
                
                // Check for unhandled promise rejection handler
                window.addEventListener('unhandledrejection', () => {
                    hasUnhandledRejectionHandler = true;
                });
                
                // Check for global error handler
                window.addEventListener('error', () => {
                    hasErrorHandler = true;
                });
                
                // Simulate a promise rejection (but catch it to prevent actual unhandled rejection)
                Promise.reject(new Error('Test rejection')).catch(() => {
                    addResult('error-results', '‚úì Promise rejection handled', 'pass');
                });
                
                setTimeout(() => {
                    if (hasUnhandledRejectionHandler) {
                        addResult('error-results', '‚úì Unhandled rejection handler present', 'pass');
                    } else {
                        addResult('error-results', '? Unhandled rejection handler not detected', 'warn');
                    }
                    
                    if (hasErrorHandler) {
                        addResult('error-results', '‚úì Global error handler present', 'pass');
                    } else {
                        addResult('error-results', '? Global error handler not detected', 'warn');
                    }
                }, 100);
                
                addResult('error-results', 'Global error handling test complete', 'info');
                
            } catch (error) {
                addResult('error-results', '‚úó Global error handling test failed', 'fail', error.message);
            }
        }

        // Database Tests
        async function testDatabaseOperations() {
            clearResults('database-results');
            addResult('database-results', 'Testing database operations...', 'running');
            
            try {
                // Test catch data structure
                const testCatch = {
                    id: 'test-' + Date.now(),
                    species: 'Test Fish',
                    length: 25.5,
                    weight: 1.2,
                    datetime: new Date().toISOString(),
                    notes: 'Test catch for testing purposes',
                    location: { latitude: 40.7128, longitude: -74.0060, name: 'Test Location' }
                };
                
                // Test save operation
                try {
                    if (typeof saveCatch === 'function') {
                        // Don't actually save, just test the function exists
                        addResult('database-results', '‚úì Save function exists', 'pass');
                    } else {
                        addResult('database-results', '‚úó Save function missing', 'fail');
                    }
                } catch (e) {
                    addResult('database-results', '‚úó Save operation failed', 'fail', e.message);
                }
                
                // Test load operation
                try {
                    if (typeof loadCatchHistory === 'function') {
                        addResult('database-results', '‚úì Load function exists', 'pass');
                        
                        // Try to load catches
                        const catches = JSON.parse(localStorage.getItem('catches') || '[]');
                        addResult('database-results', `‚úì Found ${catches.length} catches in storage`, 'pass');
                    } else {
                        addResult('database-results', '‚úó Load function missing', 'fail');
                    }
                } catch (e) {
                    addResult('database-results', '‚úó Load operation failed', 'fail', e.message);
                }
                
                // Test update operation
                if (typeof updateCatch === 'function') {
                    addResult('database-results', '‚úì Update function exists', 'pass');
                } else {
                    addResult('database-results', '‚úó Update function missing', 'fail');
                }
                
                // Test delete operation
                if (typeof deleteCatch === 'function') {
                    addResult('database-results', '‚úì Delete function exists', 'pass');
                } else {
                    addResult('database-results', '‚úó Delete function missing', 'fail');
                }
                
                addResult('database-results', 'Database operations test complete', 'info');
                
            } catch (error) {
                addResult('database-results', '‚úó Database operations test failed', 'fail', error.message);
            }
        }

        async function testIndexedDB() {
            clearResults('database-results');
            addResult('database-results', 'Testing IndexedDB...', 'running');
            
            try {
                if (!('indexedDB' in window)) {
                    addResult('database-results', '‚úó IndexedDB not supported', 'fail');
                    return;
                }
                
                // Test IndexedDB connection
                const request = indexedDB.open('TestDB', 1);
                
                request.onerror = () => {
                    addResult('database-results', '‚úó IndexedDB connection failed', 'fail');
                };
                
                request.onsuccess = () => {
                    addResult('database-results', '‚úì IndexedDB connection successful', 'pass');
                    request.result.close();
                    
                    // Clean up test database
                    indexedDB.deleteDatabase('TestDB');
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore('test', { keyPath: 'id' });
                    addResult('database-results', '‚úì IndexedDB object store created', 'pass');
                };
                
            } catch (error) {
                addResult('database-results', '‚úó IndexedDB test failed', 'fail', error.message);
            }
        }

        async function testDataPersistence() {
            clearResults('database-results');
            addResult('database-results', 'Testing data persistence...', 'running');
            
            try {
                // Test localStorage persistence
                const testData = { test: 'persistence-test', timestamp: Date.now() };
                localStorage.setItem('persistenceTest', JSON.stringify(testData));
                
                const retrievedData = JSON.parse(localStorage.getItem('persistenceTest') || '{}');
                if (retrievedData.test === 'persistence-test') {
                    addResult('database-results', '‚úì localStorage persistence works', 'pass');
                } else {
                    addResult('database-results', '‚úó localStorage persistence failed', 'fail');
                }
                
                // Clean up
                localStorage.removeItem('persistenceTest');
                
                // Test data structure integrity
                const catches = JSON.parse(localStorage.getItem('catches') || '[]');
                if (Array.isArray(catches)) {
                    addResult('database-results', '‚úì Catches data structure is valid', 'pass');
                    
                    // Check each catch for required fields
                    let validCatches = 0;
                    catches.forEach((catch_, index) => {
                        if (catch_.id && catch_.species && catch_.datetime) {
                            validCatches++;
                        }
                    });
                    
                    if (validCatches === catches.length) {
                        addResult('database-results', `‚úì All ${catches.length} catches have valid structure`, 'pass');
                    } else {
                        addResult('database-results', `‚ö† ${validCatches}/${catches.length} catches have valid structure`, 'warn');
                    }
                } else {
                    addResult('database-results', '‚úó Catches data structure is invalid', 'fail');
                }
                
            } catch (error) {
                addResult('database-results', '‚úó Data persistence test failed', 'fail', error.message);
            }
        }

        // Algorithm Tests
        async function testWeightCalculation() {
            clearResults('algorithm-results');
            addResult('algorithm-results', 'Testing weight calculation...', 'running');
            
            try {
                // Test if fish database is available
                if (typeof window.fishDB === 'undefined') {
                    addResult('algorithm-results', '‚úó Fish database not available', 'fail');
                    return;
                }
                
                // Test calculation for common species
                const testCases = [
                    { species: 'Bass', length: 30, expectedWeight: 'should be > 0' },
                    { species: 'Trout', length: 25, expectedWeight: 'should be > 0' },
                    { species: 'Salmon', length: 40, expectedWeight: 'should be > 0' }
                ];
                
                testCases.forEach(testCase => {
                    try {
                        if (window.fishDB && window.fishDB.calculateWeight) {
                            const weight = window.fishDB.calculateWeight(testCase.species, testCase.length);
                            if (weight && weight > 0) {
                                addResult('algorithm-results', `‚úì ${testCase.species} weight calculated: ${weight}kg`, 'pass');
                            } else {
                                addResult('algorithm-results', `‚ö† ${testCase.species} weight calculation returned: ${weight}`, 'warn');
                            }
                        } else {
                            addResult('algorithm-results', '‚úó Weight calculation function not available', 'fail');
                        }
                    } catch (e) {
                        addResult('algorithm-results', `‚úó Weight calculation failed for ${testCase.species}`, 'fail', e.message);
                    }
                });
                
                // Test edge cases
                try {
                    if (window.fishDB && window.fishDB.calculateWeight) {
                        const negativeResult = window.fishDB.calculateWeight('Bass', -10);
                        if (negativeResult <= 0) {
                            addResult('algorithm-results', '‚úì Negative length handled correctly', 'pass');
                        } else {
                            addResult('algorithm-results', '‚úó Negative length not handled', 'fail');
                        }
                        
                        const zeroResult = window.fishDB.calculateWeight('Bass', 0);
                        if (zeroResult <= 0) {
                            addResult('algorithm-results', '‚úì Zero length handled correctly', 'pass');
                        } else {
                            addResult('algorithm-results', '‚úó Zero length not handled', 'fail');
                        }
                    }
                } catch (e) {
                    addResult('algorithm-results', '‚úó Edge case testing failed', 'fail', e.message);
                }
                
            } catch (error) {
                addResult('algorithm-results', '‚úó Weight calculation test failed', 'fail', error.message);
            }
        }

        async function testSelfImprovingAlgorithm() {
            clearResults('algorithm-results');
            addResult('algorithm-results', 'Testing self-improving algorithm...', 'running');
            
            try {
                if (typeof window.selfImprovingAlgorithm === 'undefined') {
                    addResult('algorithm-results', '‚úó Self-improving algorithm not available', 'fail');
                    return;
                }
                
                // Test algorithm initialization
                if (window.selfImprovingAlgorithm.isInitialized) {
                    addResult('algorithm-results', '‚úì Self-improving algorithm initialized', 'pass');
                } else {
                    addResult('algorithm-results', '‚úó Self-improving algorithm not initialized', 'fail');
                }
                
                // Test learning capability
                if (typeof window.selfImprovingAlgorithm.learn === 'function') {
                    addResult('algorithm-results', '‚úì Learning function exists', 'pass');
                    
                    // Test learning with sample data
                    const sampleData = {
                        species: 'Test Fish',
                        length: 25,
                        actualWeight: 1.2,
                        predictedWeight: 1.0
                    };
                    
                    try {
                        window.selfImprovingAlgorithm.learn(sampleData);
                        addResult('algorithm-results', '‚úì Learning function executed', 'pass');
                    } catch (e) {
                        addResult('algorithm-results', '‚úó Learning function failed', 'fail', e.message);
                    }
                } else {
                    addResult('algorithm-results', '‚úó Learning function missing', 'fail');
                }
                
                // Test prediction improvement
                if (typeof window.selfImprovingAlgorithm.getAccuracy === 'function') {
                    const accuracy = window.selfImprovingAlgorithm.getAccuracy();
                    if (typeof accuracy === 'number') {
                        addResult('algorithm-results', `‚úì Algorithm accuracy: ${accuracy.toFixed(2)}%`, 'pass');
                    } else {
                        addResult('algorithm-results', '‚ö† Algorithm accuracy not available', 'warn');
                    }
                } else {
                    addResult('algorithm-results', '‚úó Accuracy function missing', 'fail');
                }
                
            } catch (error) {
                addResult('algorithm-results', '‚úó Self-improving algorithm test failed', 'fail', error.message);
            }
        }

        async function testPatternLearning() {
            clearResults('algorithm-results');
            addResult('algorithm-results', 'Testing pattern learning...', 'running');
            
            try {
                // Test pattern recognition capabilities
                if (window.selfImprovingAlgorithm && window.selfImprovingAlgorithm.analyzePatterns) {
                    addResult('algorithm-results', '‚úì Pattern analysis function exists', 'pass');
                    
                    // Test with sample patterns
                    const samplePatterns = [
                        { species: 'Bass', length: 30, weight: 1.5, season: 'spring' },
                        { species: 'Bass', length: 32, weight: 1.7, season: 'spring' },
                        { species: 'Bass', length: 28, weight: 1.3, season: 'spring' }
                    ];
                    
                    try {
                        const patterns = window.selfImprovingAlgorithm.analyzePatterns(samplePatterns);
                        if (patterns && typeof patterns === 'object') {
                            addResult('algorithm-results', '‚úì Pattern analysis completed', 'pass');
                        } else {
                            addResult('algorithm-results', '‚úó Pattern analysis returned invalid data', 'fail');
                        }
                    } catch (e) {
                        addResult('algorithm-results', '‚úó Pattern analysis failed', 'fail', e.message);
                    }
                } else {
                    addResult('algorithm-results', '‚úó Pattern analysis function missing', 'fail');
                }
                
                // Test seasonal pattern detection
                if (window.selfImprovingAlgorithm && window.selfImprovingAlgorithm.detectSeasonalPatterns) {
                    addResult('algorithm-results', '‚úì Seasonal pattern detection exists', 'pass');
                } else {
                    addResult('algorithm-results', '‚úó Seasonal pattern detection missing', 'fail');
                }
                
            } catch (error) {
                addResult('algorithm-results', '‚úó Pattern learning test failed', 'fail', error.message);
            }
        }

        // UI/UX Tests
        async function testModalFunctionality() {
            clearResults('ui-results');
            addResult('ui-results', 'Testing modal functionality...', 'running');
            
            try {
                const modals = [
                    'catch-modal', 'edit-modal', 'map-modal', 'location-name-modal',
                    'manage-species-modal', 'species-modal', 'confirmation-modal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        addResult('ui-results', `‚úì Modal ${modalId} exists`, 'pass');
                        
                        // Test modal visibility
                        if (modal.classList.contains('hidden')) {
                            addResult('ui-results', `‚úì Modal ${modalId} is hidden by default`, 'pass');
                        } else {
                            addResult('ui-results', `‚ö† Modal ${modalId} is visible by default`, 'warn');
                        }
                        
                        // Test close button
                        const closeBtn = modal.querySelector('[id*="close"]');
                        if (closeBtn) {
                            addResult('ui-results', `‚úì Modal ${modalId} has close button`, 'pass');
                        } else {
                            addResult('ui-results', `‚úó Modal ${modalId} missing close button`, 'fail');
                        }
                    } else {
                        addResult('ui-results', `‚úó Modal ${modalId} missing`, 'fail');
                    }
                });
                
                // Test modal show/hide functions
                const modalFunctions = [
                    'showCatchModal', 'hideCatchModal', 'showEditModal', 'hideEditModal'
                ];
                
                modalFunctions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        addResult('ui-results', `‚úì Function ${funcName} exists`, 'pass');
                    } else {
                        addResult('ui-results', `‚úó Function ${funcName} missing`, 'fail');
                    }
                });
                
            } catch (error) {
                addResult('ui-results', '‚úó Modal functionality test failed', 'fail', error.message);
            }
        }

        async function testTabSystem() {
            clearResults('ui-results');
            addResult('ui-results', 'Testing tab system...', 'running');
            
            try {
                const tabs = ['history-tab-btn', 'records-tab-btn', 'map-tab-btn'];
                const tabContents = ['catch-log', 'records-container', 'map-view-container'];
                
                tabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        addResult('ui-results', `‚úì Tab ${tabId} exists`, 'pass');
                        
                        // Test tab click handler
                        if (tab.onclick || tab.addEventListener) {
                            addResult('ui-results', `‚úì Tab ${tabId} has event handler`, 'pass');
                        } else {
                            addResult('ui-results', `‚ö† Tab ${tabId} event handler unclear`, 'warn');
                        }
                    } else {
                        addResult('ui-results', `‚úó Tab ${tabId} missing`, 'fail');
                    }
                });
                
                tabContents.forEach(contentId => {
                    const content = document.getElementById(contentId);
                    if (content) {
                        addResult('ui-results', `‚úì Tab content ${contentId} exists`, 'pass');
                    } else {
                        addResult('ui-results', `‚úó Tab content ${contentId} missing`, 'fail');
                    }
                });
                
                // Test active tab label
                const activeLabel = document.getElementById('active-tab-label');
                if (activeLabel) {
                    addResult('ui-results', '‚úì Active tab label exists', 'pass');
                } else {
                    addResult('ui-results', '‚úó Active tab label missing', 'fail');
                }
                
            } catch (error) {
                addResult('ui-results', '‚úó Tab system test failed', 'fail', error.message);
            }
        }

        async function testThemeSystem() {
            clearResults('ui-results');
            addResult('ui-results', 'Testing theme system...', 'running');
            
            try {
                const themeToggle = document.getElementById('theme-toggle-btn');
                if (themeToggle) {
                    addResult('ui-results', '‚úì Theme toggle button exists', 'pass');
                    
                    // Test current theme
                    const currentTheme = localStorage.getItem('theme') || 'day';
                    addResult('ui-results', `‚úì Current theme: ${currentTheme}`, 'pass');
                    
                    // Test theme attributes
                    const dataTheme = document.documentElement.getAttribute('data-theme');
                    if (currentTheme === 'night' && dataTheme === 'night') {
                        addResult('ui-results', '‚úì Night theme applied correctly', 'pass');
                    } else if (currentTheme === 'day' && !dataTheme) {
                        addResult('ui-results', '‚úì Day theme applied correctly', 'pass');
                    } else {
                        addResult('ui-results', '‚ö† Theme state inconsistent', 'warn');
                    }
                    
                    // Test theme toggle functionality
                    if (themeToggle.onclick) {
                        addResult('ui-results', '‚úì Theme toggle has click handler', 'pass');
                    } else {
                        addResult('ui-results', '‚úó Theme toggle missing click handler', 'fail');
                    }
                } else {
                    addResult('ui-results', '‚úó Theme toggle button missing', 'fail');
                }
                
            } catch (error) {
                addResult('ui-results', '‚úó Theme system test failed', 'fail', error.message);
            }
        }

        // Location & Map Tests
        async function testLocationServices() {
            clearResults('location-results');
            addResult('location-results', 'Testing location services...', 'running');
            
            try {
                // Test geolocation API availability
                if ('geolocation' in navigator) {
                    addResult('location-results', '‚úì Geolocation API available', 'pass');
                    
                    // Test location button
                    const locationBtn = document.getElementById('get-location-btn');
                    if (locationBtn) {
                        addResult('location-results', '‚úì Location button exists', 'pass');
                        
                        if (locationBtn.onclick) {
                            addResult('location-results', '‚úì Location button has click handler', 'pass');
                        } else {
                            addResult('location-results', '‚úó Location button missing click handler', 'fail');
                        }
                    } else {
                        addResult('location-results', '‚úó Location button missing', 'fail');
                    }
                    
                    // Test location status display
                    const locationStatus = document.getElementById('location-status');
                    if (locationStatus) {
                        addResult('location-results', '‚úì Location status display exists', 'pass');
                    } else {
                        addResult('location-results', '‚úó Location status display missing', 'fail');
                    }
                    
                    // Test hidden location fields
                    const locationFields = ['latitude', 'longitude', 'location-name'];
                    locationFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            addResult('location-results', `‚úì Location field ${fieldId} exists`, 'pass');
                        } else {
                            addResult('location-results', `‚úó Location field ${fieldId} missing`, 'fail');
                        }
                    });
                    
                } else {
                    addResult('location-results', '‚úó Geolocation API not available', 'fail');
                }
                
            } catch (error) {
                addResult('location-results', '‚úó Location services test failed', 'fail', error.message);
            }
        }

        async function testMapFunctionality() {
            clearResults('location-results');
            addResult('location-results', 'Testing map functionality...', 'running');
            
            try {
                // Test Leaflet availability
                if (typeof L !== 'undefined') {
                    addResult('location-results', '‚úì Leaflet.js loaded', 'pass');
                } else {
                    addResult('location-results', '‚úó Leaflet.js not loaded', 'fail');
                    return;
                }
                
                // Test map containers
                const mapContainers = ['main-map', 'map-container'];
                mapContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        addResult('location-results', `‚úì Map container ${containerId} exists`, 'pass');
                    } else {
                        addResult('location-results', `‚úó Map container ${containerId} missing`, 'fail');
                    }
                });
                
                // Test map modal
                const mapModal = document.getElementById('map-modal');
                if (mapModal) {
                    addResult('location-results', '‚úì Map modal exists', 'pass');
                    
                    // Test map modal components
                    const mapModalComponents = [
                        'close-map-modal-btn', 'use-current-location-btn', 
                        'save-map-location-btn', 'location-name-input'
                    ];
                    
                    mapModalComponents.forEach(componentId => {
                        const component = document.getElementById(componentId);
                        if (component) {
                            addResult('location-results', `‚úì Map modal component ${componentId} exists`, 'pass');
                        } else {
                            addResult('location-results', `‚úó Map modal component ${componentId} missing`, 'fail');
                        }
                    });
                } else {
                    addResult('location-results', '‚úó Map modal missing', 'fail');
                }
                
                // Test map variables
                if (typeof window.map !== 'undefined') {
                    addResult('location-results', '‚úì Map variable exists', 'pass');
                } else {
                    addResult('location-results', '‚ö† Map variable not initialized', 'warn');
                }
                
            } catch (error) {
                addResult('location-results', '‚úó Map functionality test failed', 'fail', error.message);
            }
        }

        async function testGeolocation() {
            clearResults('location-results');
            addResult('location-results', 'Testing geolocation...', 'running');
            
            try {
                if ('geolocation' in navigator) {
                    addResult('location-results', '‚úì Geolocation supported', 'pass');
                    
                    // Test geolocation permissions
                    navigator.permissions.query({ name: 'geolocation' }).then(result => {
                        addResult('location-results', `‚úì Geolocation permission: ${result.state}`, 'pass');
                    }).catch(() => {
                        addResult('location-results', '‚ö† Geolocation permission query failed', 'warn');
                    });
                    
                    // Test location accuracy options
                    const geoOptions = {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    };
                    
                    addResult('location-results', '‚úì Geolocation options configured', 'pass');
                    
                } else {
                    addResult('location-results', '‚úó Geolocation not supported', 'fail');
                }
                
            } catch (error) {
                addResult('location-results', '‚úó Geolocation test failed', 'fail', error.message);
            }
        }

        // Photo & Media Tests
        async function testPhotoHandling() {
            clearResults('photo-results');
            addResult('photo-results', 'Testing photo handling...', 'running');
            
            try {
                // Test photo upload button
                const photoBtn = document.getElementById('photo-upload-btn');
                if (photoBtn) {
                    addResult('photo-results', '‚úì Photo upload button exists', 'pass');
                } else {
                    addResult('photo-results', '‚úó Photo upload button missing', 'fail');
                }
                
                // Test photo input
                const photoInput = document.getElementById('photo');
                if (photoInput) {
                    addResult('photo-results', '‚úì Photo input exists', 'pass');
                    
                    if (photoInput.accept === 'image/*') {
                        addResult('photo-results', '‚úì Photo input accepts images', 'pass');
                    } else {
                        addResult('photo-results', '‚úó Photo input accept attribute incorrect', 'fail');
                    }
                } else {
                    addResult('photo-results', '‚úó Photo input missing', 'fail');
                }
                
                // Test File API availability
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    addResult('photo-results', '‚úì File API available', 'pass');
                } else {
                    addResult('photo-results', '‚úó File API not fully supported', 'fail');
                }
                
                // Test photo display elements
                const photoElements = ['modal-photo', 'modal-photo-container'];
                photoElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        addResult('photo-results', `‚úì Photo element ${elementId} exists`, 'pass');
                    } else {
                        addResult('photo-results', `‚úó Photo element ${elementId} missing`, 'fail');
                    }
                });
                
            } catch (error) {
                addResult('photo-results', '‚úó Photo handling test failed', 'fail', error.message);
            }
        }

        async function testImageProcessing() {
            clearResults('photo-results');
            addResult('photo-results', 'Testing image processing...', 'running');
            
            try {
                // Test Canvas API for image processing
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (ctx) {
                    addResult('photo-results', '‚úì Canvas API available for image processing', 'pass');
                } else {
                    addResult('photo-results', '‚úó Canvas API not available', 'fail');
                }
                
                // Test image compression capabilities
                if (HTMLCanvasElement.prototype.toBlob) {
                    addResult('photo-results', '‚úì Image compression supported', 'pass');
                } else {
                    addResult('photo-results', '‚úó Image compression not supported', 'fail');
                }
                
                // Test image resizing
                const img = new Image();
                img.onload = function() {
                    addResult('photo-results', '‚úì Image loading works', 'pass');
                };
                img.onerror = function() {
                    addResult('photo-results', '‚úó Image loading failed', 'fail');
                };
                
                // Test with a small data URL
                img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                
            } catch (error) {
                addResult('photo-results', '‚úó Image processing test failed', 'fail', error.message);
            }
        }

        async function testFullscreenImage() {
            clearResults('photo-results');
            addResult('photo-results', 'Testing fullscreen image...', 'running');
            
            try {
                // Test fullscreen modal
                const fullscreenModal = document.getElementById('fullscreen-image');
                if (fullscreenModal) {
                    addResult('photo-results', '‚úì Fullscreen modal exists', 'pass');
                    
                    if (fullscreenModal.classList.contains('hidden')) {
                        addResult('photo-results', '‚úì Fullscreen modal hidden by default', 'pass');
                    } else {
                        addResult('photo-results', '‚úó Fullscreen modal visible by default', 'fail');
                    }
                } else {
                    addResult('photo-results', '‚úó Fullscreen modal missing', 'fail');
                }
                
                // Test fullscreen image element
                const fullscreenImg = document.getElementById('fullscreen-image-content');
                if (fullscreenImg) {
                    addResult('photo-results', '‚úì Fullscreen image element exists', 'pass');
                } else {
                    addResult('photo-results', '‚úó Fullscreen image element missing', 'fail');
                }
                
                // Test fullscreen controls
                const fullscreenControls = ['rotate-image-btn', 'close-fullscreen-btn'];
                fullscreenControls.forEach(controlId => {
                    const control = document.getElementById(controlId);
                    if (control) {
                        addResult('photo-results', `‚úì Fullscreen control ${controlId} exists`, 'pass');
                    } else {
                        addResult('photo-results', `‚úó Fullscreen control ${controlId} missing`, 'fail');
                    }
                });
                
                // Test touch/zoom capabilities
                if ('ontouchstart' in window) {
                    addResult('photo-results', '‚úì Touch events available', 'pass');
                } else {
                    addResult('photo-results', '‚ö† Touch events not available (desktop)', 'warn');
                }
                
            } catch (error) {
                addResult('photo-results', '‚úó Fullscreen image test failed', 'fail', error.message);
            }
        }

        // Data Management Tests
        async function testDataExport() {
            clearResults('data-results');
            addResult('data-results', 'Testing data export...', 'running');
            
            try {
                // Test export button
                const exportBtn = document.getElementById('export-data-btn');
                if (exportBtn) {
                    addResult('data-results', '‚úì Export button exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Export button missing', 'fail');
                }
                
                // Test data export functionality
                if (typeof window.exportData === 'function') {
                    addResult('data-results', '‚úì Export function exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Export function missing', 'fail');
                }
                
                // Test Blob API for file creation
                if (window.Blob) {
                    addResult('data-results', '‚úì Blob API available', 'pass');
                } else {
                    addResult('data-results', '‚úó Blob API not available', 'fail');
                }
                
                // Test URL creation for downloads
                if (window.URL && window.URL.createObjectURL) {
                    addResult('data-results', '‚úì URL.createObjectURL available', 'pass');
                } else {
                    addResult('data-results', '‚úó URL.createObjectURL not available', 'fail');
                }
                
                // Test data structure for export
                const catches = JSON.parse(localStorage.getItem('catches') || '[]');
                if (Array.isArray(catches)) {
                    addResult('data-results', `‚úì Export data structure valid (${catches.length} catches)`, 'pass');
                } else {
                    addResult('data-results', '‚úó Export data structure invalid', 'fail');
                }
                
            } catch (error) {
                addResult('data-results', '‚úó Data export test failed', 'fail', error.message);
            }
        }

        async function testDataImport() {
            clearResults('data-results');
            addResult('data-results', 'Testing data import...', 'running');
            
            try {
                // Test import input
                const importInput = document.getElementById('import-data-input');
                if (importInput) {
                    addResult('data-results', '‚úì Import input exists', 'pass');
                    
                    if (importInput.accept === '.json') {
                        addResult('data-results', '‚úì Import input accepts JSON', 'pass');
                    } else {
                        addResult('data-results', '‚úó Import input accept attribute incorrect', 'fail');
                    }
                } else {
                    addResult('data-results', '‚úó Import input missing', 'fail');
                }
                
                // Test import label
                const importLabel = document.querySelector('label[for="import-data-input"]');
                if (importLabel) {
                    addResult('data-results', '‚úì Import label exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Import label missing', 'fail');
                }
                
                // Test FileReader API
                if (window.FileReader) {
                    addResult('data-results', '‚úì FileReader API available', 'pass');
                } else {
                    addResult('data-results', '‚úó FileReader API not available', 'fail');
                }
                
                // Test JSON parsing capabilities
                try {
                    const testData = '{"test": "import"}';
                    const parsed = JSON.parse(testData);
                    addResult('data-results', '‚úì JSON parsing works', 'pass');
                } catch (e) {
                    addResult('data-results', '‚úó JSON parsing failed', 'fail');
                }
                
            } catch (error) {
                addResult('data-results', '‚úó Data import test failed', 'fail', error.message);
            }
        }

        async function testSpeciesManagement() {
            clearResults('data-results');
            addResult('data-results', 'Testing species management...', 'running');
            
            try {
                // Test species management button
                const manageBtn = document.getElementById('manage-species-btn');
                if (manageBtn) {
                    addResult('data-results', '‚úì Manage species button exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Manage species button missing', 'fail');
                }
                
                // Test species management modal
                const manageModal = document.getElementById('manage-species-modal');
                if (manageModal) {
                    addResult('data-results', '‚úì Manage species modal exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Manage species modal missing', 'fail');
                }
                
                // Test species input and dropdown
                const speciesInput = document.getElementById('species');
                const speciesDropdown = document.getElementById('species-dropdown');
                
                if (speciesInput) {
                    addResult('data-results', '‚úì Species input exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Species input missing', 'fail');
                }
                
                if (speciesDropdown) {
                    addResult('data-results', '‚úì Species dropdown exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Species dropdown missing', 'fail');
                }
                
                // Test custom species storage
                const customSpecies = JSON.parse(localStorage.getItem('customSpecies') || '[]');
                if (Array.isArray(customSpecies)) {
                    addResult('data-results', `‚úì Custom species storage valid (${customSpecies.length} species)`, 'pass');
                } else {
                    addResult('data-results', '‚úó Custom species storage invalid', 'fail');
                }
                
                // Test add species functionality
                const addSpeciesBtn = document.getElementById('add-species-btn');
                if (addSpeciesBtn) {
                    addResult('data-results', '‚úì Add species button exists', 'pass');
                } else {
                    addResult('data-results', '‚úó Add species button missing', 'fail');
                }
                
            } catch (error) {
                addResult('data-results', '‚úó Species management test failed', 'fail', error.message);
            }
        }

        // Performance Tests
        async function testPerformanceMetrics() {
            clearResults('performance-results');
            addResult('performance-results', 'Testing performance metrics...', 'running');
            
            try {
                // Test Performance API
                if (window.performance) {
                    addResult('performance-results', '‚úì Performance API available', 'pass');
                    
                    const navigation = performance.getEntriesByType('navigation')[0];
                    if (navigation) {
                        const loadTime = navigation.loadEventEnd - navigation.loadEventStart;
                        addResult('performance-results', `‚úì Page load time: ${loadTime}ms`, 'pass');
                        
                        const domContentLoaded = navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart;
                        addResult('performance-results', `‚úì DOM content loaded: ${domContentLoaded}ms`, 'pass');
                    }
                } else {
                    addResult('performance-results', '‚úó Performance API not available', 'fail');
                }
                
                // Test timing functions
                const start = performance.now();
                for (let i = 0; i < 10000; i++) {
                    // Simple operation
                }
                const end = performance.now();
                addResult('performance-results', `‚úì Timing test: ${(end - start).toFixed(2)}ms`, 'pass');
                
            } catch (error) {
                addResult('performance-results', '‚úó Performance metrics test failed', 'fail', error.message);
            }
        }

        async function testMemoryUsage() {
            clearResults('performance-results');
            addResult('performance-results', 'Testing memory usage...', 'running');
            
            try {
                if (performance.memory) {
                    const memory = performance.memory;
                    addResult('performance-results', `‚úì Used JS heap: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'pass');
                    addResult('performance-results', `‚úì Total JS heap: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'pass');
                    addResult('performance-results', `‚úì JS heap limit: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`, 'pass');
                } else {
                    addResult('performance-results', '‚ö† Memory API not available', 'warn');
                }
                
                // Test localStorage usage
                let localStorageSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        localStorageSize += localStorage[key].length;
                    }
                }
                addResult('performance-results', `‚úì localStorage usage: ${(localStorageSize / 1024).toFixed(2)} KB`, 'pass');
                
            } catch (error) {
                addResult('performance-results', '‚úó Memory usage test failed', 'fail', error.message);
            }
        }

        async function testLoadTimes() {
            clearResults('performance-results');
            addResult('performance-results', 'Testing load times...', 'running');
            
            try {
                // Test resource loading times
                const resources = performance.getEntriesByType('resource');
                if (resources.length > 0) {
                    addResult('performance-results', `‚úì Found ${resources.length} resources`, 'pass');
                    
                    const slowResources = resources.filter(r => r.duration > 1000);
                    if (slowResources.length > 0) {
                        addResult('performance-results', `‚ö† ${slowResources.length} slow resources (>1s)`, 'warn');
                    } else {
                        addResult('performance-results', '‚úì All resources loaded quickly', 'pass');
                    }
                } else {
                    addResult('performance-results', '‚ö† No resource timing data', 'warn');
                }
                
                // Test DOM ready time
                if (document.readyState === 'complete') {
                    addResult('performance-results', '‚úì DOM completely loaded', 'pass');
                } else {
                    addResult('performance-results', '‚ö† DOM not fully loaded', 'warn');
                }
                
            } catch (error) {
                addResult('performance-results', '‚úó Load times test failed', 'fail', error.message);
            }
        }
        
        // Run All Tests Function
        async function runFullTestSuite() {
            if (isRunning) {
                addResult('test-summary', 'Tests already running...', 'warn');
                return;
            }
            
            isRunning = true;
            clearAllResults();
            
            document.getElementById('test-summary').innerHTML = '<p>Running comprehensive test suite...</p>';
            
            try {
                // Run all test categories
                await testCoreFunctionality();
                await testDOMElements();
                await testFormValidation();
                await testErrorHandler();
                await testCustomErrors();
                await testGlobalErrorHandling();
                await testDatabaseOperations();
                await testIndexedDB();
                await testDataPersistence();
                await testWeightCalculation();
                await testSelfImprovingAlgorithm();
                await testPatternLearning();
                await testModalFunctionality();
                await testTabSystem();
                await testThemeSystem();
                await testLocationServices();
                await testMapFunctionality();
                await testGeolocation();
                await testPhotoHandling();
                await testImageProcessing();
                await testFullscreenImage();
                await testDataExport();
                await testDataImport();
                await testSpeciesManagement();
                await testPerformanceMetrics();
                await testMemoryUsage();
                await testLoadTimes();
                
                // Generate summary
                const summary = `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-bold mb-2">Test Results Summary</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400">${testStats.total}</div>
                                <div class="text-sm">Total Tests</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400">${testStats.passed}</div>
                                <div class="text-sm">Passed</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-400">${testStats.failed}</div>
                                <div class="text-sm">Failed</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">${testStats.warnings}</div>
                                <div class="text-sm">Warnings</div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="text-sm mb-2">Success Rate: ${testStats.total > 0 ? Math.round((testStats.passed / testStats.total) * 100) : 0}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${testStats.total > 0 ? (testStats.passed / testStats.total) * 100 : 0}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('test-summary').innerHTML = summary;
                
            } catch (error) {
                document.getElementById('test-summary').innerHTML = `<p class="text-red-400">Test suite failed: ${error.message}</p>`;
            } finally {
                isRunning = false;
            }
        }

        // Export test results
        function exportTestResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                stats: testStats,
                results: testResults,
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fish-log-test-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize test page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Test suite initialized');
            updateTestStats();
        });
    </script>
</body>
</html>
