name: Deploy Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - experimental-dev

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-production"
  cancel-in-progress: false

jobs:
  build-production:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.deploy_branch || github.ref }}

    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Clean build directory
      run: |
        # Remove development files
        rm -rf node_modules/
        rm -rf .git/
        rm -rf .github/
        rm -rf "Species Data Analyzer/"
        rm -rf "Fish App DB Files/"
        rm -rf "New folder/"
        rm -f *.md
        rm -f *.txt
        rm -f *.workspace
        rm -f package*.json
        rm -f h\ origin\ main
        rm -f hell\ -NoProfile\ git\ status\ --short
        rm -f tatus
        rm -f temp-css.css
        
        # Keep only essential PWA files
        mkdir -p dist
        cp index.html dist/
        cp -r css/ dist/ 2>/dev/null || true
        cp -r js/ dist/ 2>/dev/null || true
        cp manifest.json dist/ 2>/dev/null || true
        cp sw.js dist/ 2>/dev/null || true
        cp favicon.svg dist/ 2>/dev/null || true
        cp suggestions.jpg dist/ 2>/dev/null || true
        cp Splashscreen.png dist/ 2>/dev/null || true
        cp fish_algorithms.json dist/ 2>/dev/null || true
        cp _config.yml dist/ 2>/dev/null || true
        
        # Update service worker cache for the deployed branch
        DEPLOY_BRANCH="${{ github.event.inputs.deploy_branch || 'main' }}"
        if [ -f dist/sw.js ]; then
          # Update cache name with branch and timestamp
          sed -i "s/const CACHE_NAME = .*/const CACHE_NAME = 'ghoti-${DEPLOY_BRANCH}-$(date +%s)';/" dist/sw.js

          # If deploying main branch (without game), remove game files from service worker cache
          if [ "$DEPLOY_BRANCH" = "main" ]; then
            # Remove game-related files from ASSETS_TO_CACHE array
            sed -i "/fishingGame/d" dist/sw.js
            sed -i "/game[A-Z]/d" dist/sw.js
            sed -i "/motionPermission/d" dist/sw.js
            sed -i "/motionSensor/d" dist/sw.js
            sed -i "/sensorFilters/d" dist/sw.js
            sed -i "/inputManager/d" dist/sw.js
            sed -i "/confetti-effects/d" dist/sw.js
            sed -i "/magicui-components/d" dist/sw.js
          fi
        fi
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  deploy-production:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-production
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4