<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghoti - Hooked | Fishing Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @font-face {
        font-family: 'LucideIcons';
        /* Using unpkg CDN */
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons';
        font-size: 1.25rem; /* Adjust icon size */
        line-height: 1;
        display: inline-block; /* Ensure proper alignment */
        vertical-align: middle; /* Align icon vertically */
      }
      /* Custom style for disabled button */
      .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      /* Hide elements by default */
      .hidden {
        display: none;
      }

      /* --- Landing Page Background --- */
      #landing-page {
        position: fixed;
        inset: 0;
        color: white;
        z-index: 50;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background-size: cover;
        background-position: center;
        transition: opacity 0.5s ease-out;
      }

      #landing-page.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      #app-content {
        opacity: 1;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        position: absolute;
        top: 0;
        left: 0;
      }

      /* Remove unnecessary spacing adjustments */
      .app-container {
        height: 100%;
        overflow-y: auto;
        position: relative;
      }

      .form-section {
        padding: 1.5rem;
      }

      /* Semi-transparent overlay for text readability */
      #landing-page::before {
        content: "";
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: -1;
      }
      /* --- End Landing Page Background --- */

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <script>
        // Tailwind config (works with @tailwindcss/browser)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-sky-100 to-blue-200 font-sans min-h-screen flex items-center justify-center p-4">

    <div class="container mx-auto max-w-3xl bg-white rounded-xl shadow-lg overflow-hidden">
        <div id="landing-page" class="p-4 md:p-8 text-center" style="background-image: url('IMG-20160902-WA0002.jpg');">
            <div id="landing-header" class="relative z-10">
                <h1 class="text-3xl md:text-5xl font-bold mb-2">Ghoti - Hooked</h1>
                <p class="text-lg md:text-xl">Log your catches and track your fishing journey</p>
            </div>
            <div id="landing-footer" class="relative z-10">
                <button id="enter-app-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-colors w-full md:w-auto">
                    Enter Logbook
                </button>
            </div>
        </div>

        <div id="app-content" class="hidden app-container">
            <div class="form-section">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-4 flex items-center justify-center gap-2">
                    <span class="lucide"></span> Ghoti - Hooked Logbook
                </h1>

                <form id="catch-form" class="mb-8 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Log a New Catch</h2>

                    <div>
                        <label for="species" class="block text-sm font-medium text-gray-600 mb-1">Species:</label>
                        <div class="relative">
                            <input type="text" id="species" name="species" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                                placeholder="Search or enter species name">
                            <div id="species-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                <!-- Species suggestions will be populated here -->
                            </div>
                            <button type="button" id="manage-species-btn" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                title="Manage Species List">
                                ⚙
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="length" class="block text-sm font-medium text-gray-600 mb-1">Length (cm):</label>
                            <input type="number" id="length" name="length" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-600 mb-1">Weight (kg):</label>
                            <input type="number" id="weight" name="weight" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div>
                        <label for="datetime" class="block text-sm font-medium text-gray-600 mb-1">Date & Time:</label>
                        <input type="datetime-local" id="datetime" name="datetime" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">Notes:</label>
                        <textarea id="notes" name="notes" rows="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div class="border-t pt-4 space-y-2">
                        <label class="block text-sm font-medium text-gray-600">Location:</label>
                        <div class="flex items-center gap-4 flex-wrap">
                            <button type="button" id="get-location-btn" class="flex items-center gap-1 px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-sm">
                                <span class="lucide"></span> Get Current Location
                            </button>
                            <span id="location-status" class="text-sm text-gray-500">Location not saved.</span>
                        </div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>

                    <div class="photo-upload">
                        <label for="photo" class="block text-sm font-medium text-gray-600 mb-2">Photo:</label>
                        <input type="file" id="photo" name="photo" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Upload a photo of your catch (optional)</p>
                    </div>

                    <div id="message-box" class="hidden p-3 rounded-md text-sm"></div>

                    <button type="submit" class="w-full mt-4 flex justify-center items-center gap-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 text-lg">
                        <span class="lucide"></span> Save Catch
                    </button>
                </form>

                <div>
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Catch History</h2>
                        <button id="back-to-landing-btn" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                            <span class="lucide text-base"></span> Back to Home
                        </button>
                    </div>
                    <div id="catch-log" class="space-y-4">
                        <p class="text-gray-500 italic">No catches logged yet.</p>
                    </div>
                    <button id="clear-log-btn" class="mt-6 px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 text-sm flex items-center gap-1 hidden">
                        <span class="lucide"></span> Clear All Logs
                    </button>
                    <div id="pagination-controls" class="hidden justify-between mt-4">
                        <button id="prev-page-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400" disabled>Previous</button>
                        <button id="next-page-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400" disabled>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="catch-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" data-modal-background>
        <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-md max-h-[90vh] overflow-y-auto relative">
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 p-2 z-10">
                ✖
            </button>
            <div class="space-y-3">
                <h3 id="modal-species" class="text-xl font-bold text-blue-700 pr-8"></h3>
                <p id="modal-date" class="text-sm text-gray-500"></p>
                
                <div class="flex flex-wrap gap-2">
                    <p id="modal-length" class="text-sm text-gray-600"></p>
                    <p id="modal-weight" class="text-sm text-gray-600"></p>
                </div>
                
                <div id="modal-location-container" class="text-sm text-gray-600">
                    <p class="flex flex-wrap items-center gap-1">
                        <span>Location:</span>
                        <a id="modal-location-name" href="#" class="text-blue-600 hover:underline"></a>
                    </p>
                </div>
                
                <p id="modal-notes" class="text-sm text-gray-600"></p>
                
                <div id="modal-photo-container" class="mb-4 hidden">
                    <img id="modal-photo" class="w-full h-auto rounded-md cursor-pointer" alt="Catch Photo">
                    <p class="text-xs text-gray-500 mt-1">Tap image to view full size</p>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button id="edit-catch-btn" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600">
                        Edit
                    </button>
                    <button id="delete-catch-btn" class="flex-1 px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-md max-h-[90vh] overflow-y-auto relative">
            <button id="close-edit-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 p-2 z-10">
                ✖
            </button>
            <form id="edit-catch-form" class="space-y-4">
                <h3 class="text-xl font-bold text-blue-700">Edit Catch</h3>
                
                <div>
                    <label for="edit-species" class="block text-sm font-medium text-gray-600 mb-1">Species:</label>
                    <input type="text" id="edit-species" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-length" class="block text-sm font-medium text-gray-600 mb-1">Length (cm):</label>
                        <input type="number" id="edit-length" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="edit-weight" class="block text-sm font-medium text-gray-600 mb-1">Weight (kg):</label>
                        <input type="number" id="edit-weight" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>

                <div>
                    <label for="edit-datetime" class="block text-sm font-medium text-gray-600 mb-1">Date & Time:</label>
                    <input type="datetime-local" id="edit-datetime" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label for="edit-location-name" class="block text-sm font-medium text-gray-600 mb-1">Location Name:</label>
                    <input type="text" id="edit-location-name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>

                <div>
                    <label for="edit-notes" class="block text-sm font-medium text-gray-600 mb-1">Notes:</label>
                    <textarea id="edit-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-600">Photo:</label>
                    <button type="button" id="edit-photo-btn" class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-md border border-gray-300 flex items-center justify-center gap-2">
                        <span id="edit-photo-text">Edit Photo</span>
                    </button>
                    <input type="file" id="edit-photo-input" accept="image/*" class="hidden">
                </div>

                <input type="hidden" id="edit-catch-id">
                <input type="hidden" id="edit-latitude">
                <input type="hidden" id="edit-longitude">
                <input type="hidden" id="edit-photo">

                <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Add location name modal -->
    <div id="location-name-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-md">
            <h3 class="text-xl font-bold text-blue-700 mb-4">Save Location</h3>
            <form id="location-name-form" class="space-y-4">
                <div>
                    <label for="modal-location-name-input" class="block text-sm font-medium text-gray-600 mb-1">Location Name:</label>
                    <input type="text" id="modal-location-name-input" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600">
                        Save
                    </button>
                    <button type="button" id="cancel-location-name-btn" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update fullscreen image modal -->
    <div id="fullscreen-image" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[60] flex items-center justify-center">
        <div class="max-w-full max-h-full p-4">
            <img id="fullscreen-image-content" class="max-h-[90vh] max-w-[90vw] object-contain" alt="Full size catch photo">
        </div>
        <button class="absolute top-4 right-4 text-white text-xl" onclick="closeFullscreenImage()">✖</button>
        <p class="text-white text-sm absolute bottom-4">Tap anywhere to close</p>
    </div>

    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="text-white text-lg">Loading...</div>
    </div>

    <div id="species-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-md">
            <h3 class="text-xl font-bold text-blue-700 mb-4">Add New Species</h3>
            <form id="species-form" class="space-y-4">
                <div>
                    <label for="new-species-name" class="block text-sm font-medium text-gray-600 mb-1">Species Name:</label>
                    <input type="text" id="new-species-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow-md hover:bg-blue-600">
                        Save
                    </button>
                    <button type="button" id="cancel-species-btn" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage-species-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-700">Manage Species</h3>
                <button class="text-gray-500 hover:text-gray-700" id="close-manage-species-btn">✖</button>
            </div>
            <div class="space-y-4">
                <div id="custom-species-list" class="space-y-2">
                    <!-- Custom species will be listed here -->
                </div>
                <button id="add-species-btn" class="w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-md shadow-md hover:bg-green-600">
                    Add New Species
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const landingPage = document.getElementById('landing-page');
        const appContent = document.getElementById('app-content');
        const enterAppBtn = document.getElementById('enter-app-btn');
        const backToLandingBtn = document.getElementById('back-to-landing-btn');

        const catchForm = document.getElementById('catch-form');
        const speciesInput = document.getElementById('species');
        const lengthInput = document.getElementById('length');
        const weightInput = document.getElementById('weight');
        const datetimeInput = document.getElementById('datetime');
        const notesInput = document.getElementById('notes');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const catchLogContainer = document.getElementById('catch-log');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const messageBox = document.getElementById('message-box');

        let currentPage = 0;
        const itemsPerPage = 5;

        // --- Species Data and Calculations ---
        const fishSpeciesData = {
            // Freshwater Species
            'Bass, Largemouth': { a: 0.0115, b: 3.0, minLength: 20, maxLength: 70 },
            'Carp, Common': { a: 0.0305, b: 3.0, minLength: 30, maxLength: 100 },
            'Carp, Mirror': { a: 0.0305, b: 3.0, minLength: 30, maxLength: 100 },
            'Carp, Grass': { a: 0.0230, b: 3.0, minLength: 30, maxLength: 120 },
            'Barbel, Sharptooth Catfish': { a: 0.0260, b: 3.0, minLength: 30, maxLength: 150 },
            'Yellowfish, Smallscale': { a: 0.0140, b: 3.0, minLength: 20, maxLength: 60 },
            'Tilapia, Mozambique': { a: 0.0180, b: 3.0, minLength: 15, maxLength: 40 },
            
            // Marine Species
            'Kob, Dusky': { a: 0.0082, b: 3.0, minLength: 40, maxLength: 130 },
            'Galjoen': { a: 0.0220, b: 3.0, minLength: 30, maxLength: 70 },
            'Yellowtail': { a: 0.0126, b: 3.0, minLength: 50, maxLength: 120 },
            'Cape Salmon (Geelbek)': { a: 0.0074, b: 3.0, minLength: 60, maxLength: 130 },
            'Garrick (Leervis)': { a: 0.0091, b: 3.0, minLength: 50, maxLength: 120 },
            'Blacktail (Dassie)': { a: 0.0180, b: 3.0, minLength: 20, maxLength: 45 },
            'White Steenbras': { a: 0.0160, b: 3.0, minLength: 40, maxLength: 90 },
            'Red Steenbras': { a: 0.0185, b: 3.0, minLength: 50, maxLength: 100 },
            'White Musselcracker': { a: 0.0200, b: 3.0, minLength: 40, maxLength: 110 },
            'Black Musselcracker': { a: 0.0210, b: 3.0, minLength: 50, maxLength: 120 }
        };

        function calculateExpectedWeight(species, length) {
            const data = fishSpeciesData[species];
            if (!data) return null;
            
            // W = a * L^b where:
            // W is weight in kg
            // L is length in cm
            // a and b are species-specific parameters
            const weight = data.a * Math.pow(length, data.b);
            return parseFloat(weight.toFixed(2));
        }

        function getWeightRange(species, length) {
            const expectedWeight = calculateExpectedWeight(species, length);
            if (!expectedWeight) return null;
            
            // Calculate a range of ±15% from the expected weight
            const minWeight = (expectedWeight * 0.85).toFixed(2);
            const maxWeight = (expectedWeight * 1.15).toFixed(2);
            return { min: minWeight, max: maxWeight, expected: expectedWeight };
        }

        // Update predefined species list with the new species data
        const predefinedSpecies = Object.keys(fishSpeciesData);

        // --- Navigation ---
        function showApp() {
            landingPage.classList.add('fade-out');
            appContent.classList.remove('hidden');
            // Reset scroll position
            window.scrollTo(0, 0);
            // Give a small delay to start the fade in
            setTimeout(() => {
                appContent.classList.add('fade-in');
                // Remove the landing page from DOM after transition
                setTimeout(() => {
                    landingPage.classList.add('hidden');
                    // Blur any focused elements
                    if (document.activeElement instanceof HTMLElement) {
                        document.activeElement.blur();
                    }
                }, 500);
            }, 50);
            renderCatches();
            setDefaultDateTime();
        }

        function showLandingPage() {
            landingPage.classList.remove('hidden', 'fade-out');
            appContent.classList.remove('fade-in');
            setTimeout(() => {
                appContent.classList.add('hidden');
            }, 500);
        }

        // --- Utility Functions ---
        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = `p-3 rounded-md text-sm ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date)) {
                return 'Invalid Date';
            }
            const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            return localDate.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

         function setDefaultDateTime() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            datetimeInput.value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        }

        // --- Geolocation ---
        function handleGetLocation() {
            if (!navigator.geolocation) {
                locationStatus.textContent = 'Geolocation not supported.';
                locationStatus.classList.add('text-red-600');
                getLocationBtn.disabled = true;
                getLocationBtn.classList.add('btn-disabled');
                return;
            }

            locationStatus.textContent = 'Getting location...';
            locationStatus.classList.remove('text-red-600', 'text-green-600');
            getLocationBtn.disabled = true;
            getLocationBtn.classList.add('btn-disabled');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Show location name modal
                    const locationNameModal = document.getElementById('location-name-modal');
                    const locationNameInput = document.getElementById('modal-location-name-input');
                    const locationNameForm = document.getElementById('location-name-form');
                    const cancelLocationNameBtn = document.getElementById('cancel-location-name-btn');

                    locationNameModal.classList.remove('hidden');
                    locationNameInput.value = '';

                    locationNameForm.onsubmit = (e) => {
                        e.preventDefault();
                        const locationName = locationNameInput.value.trim();
                        if (locationName) {
                            latitudeInput.value = lat;
                            longitudeInput.value = lon;
                            document.getElementById('location-name').value = locationName;
                            locationStatus.textContent = `Location saved: ${locationName}`;
                            locationStatus.classList.add('text-green-600');
                        } else {
                            locationStatus.textContent = 'Location not saved.';
                            locationStatus.classList.remove('text-green-600');
                            latitudeInput.value = '';
                            longitudeInput.value = '';
                        }
                        locationNameModal.classList.add('hidden');
                        getLocationBtn.disabled = false;
                        getLocationBtn.classList.remove('btn-disabled');
                    };

                    cancelLocationNameBtn.onclick = () => {
                        locationNameModal.classList.add('hidden');
                        locationStatus.textContent = 'Location not saved.';
                        locationStatus.classList.remove('text-green-600');
                        latitudeInput.value = '';
                        longitudeInput.value = '';
                        getLocationBtn.disabled = false;
                        getLocationBtn.classList.remove('btn-disabled');
                    };
                },
                (error) => {
                    let errorMsg = 'Unable to retrieve location.';
                    if (error.code === error.PERMISSION_DENIED) errorMsg = "Location access denied.";
                    else if (error.code === error.POSITION_UNAVAILABLE) errorMsg = "Location unavailable.";
                    else if (error.code === error.TIMEOUT) errorMsg = "Location request timed out.";

                    locationStatus.textContent = errorMsg;
                    locationStatus.classList.add('text-red-600');
                    latitudeInput.value = '';
                    longitudeInput.value = '';
                    getLocationBtn.disabled = false;
                    getLocationBtn.classList.remove('btn-disabled');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // --- Local Storage & Data Handling ---
        if (typeof localStorage === 'undefined' || localStorage === null) {
            alert('Local storage is not supported on this device. Data will not be saved.');
        }

        if (!window.indexedDB) {
            alert('Your browser does not support IndexedDB. Data will not be saved.');
        }

        function getCatches() {
            const catchesJSON = localStorage.getItem('ghotiFishingLogCatches');
            try {
                // Ensure catches are always returned as an array
                const parsed = catchesJSON ? JSON.parse(catchesJSON) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error("Error parsing catches from localStorage:", e);
                 localStorage.removeItem('ghotiFishingLogCatches'); // Clear corrupted data
                return [];
            }
        }

        function saveCatches(catches) {
            // Ensure we are saving an array
             if (!Array.isArray(catches)) {
                console.error("Attempted to save non-array data to catches:", catches);
                return; // Prevent saving invalid data
            }
            try {
                // Sort catches by date descending before saving
                catches.sort((a, b) => {
                    const dateA = a.datetime ? new Date(a.datetime) : 0;
                    const dateB = b.datetime ? new Date(a.datetime) : 0;
                    return dateB - dateA;
                });
                localStorage.setItem('ghotiFishingLogCatches', JSON.stringify(catches));
            } catch (e) {
                console.error("Error saving catches to localStorage:", e);
                showMessage("Could not save catch data. Storage might be full.", 'error');
            }
        }


        function addCatch(event) {
            event.preventDefault();

            const locationNameInput = document.getElementById('location-name');
            const photoInput = document.getElementById('photo');

            // Convert photo to Base64 if a file is uploaded
            const photoFile = photoInput.files[0];

            if (photoFile) {
                resizeImage(photoFile, 800, 800, (resizedDataUrl) => {
                    const newCatch = createCatchObject({
                        species: speciesInput.value.trim(),
                        length: lengthInput.value ? parseFloat(lengthInput.value) : null,
                        weight: weightInput.value ? parseFloat(lengthInput.value) : null,
                        datetime: datetimeInput.value,
                        notes: notesInput.value.trim(),
                        latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                        longitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                        locationName: locationNameInput.value.trim() || null,
                        photo: resizedDataUrl
                    });
                    saveCatchToIndexedDB(newCatch);
                });
            } else {
                const newCatch = createCatchObject({
                    species: speciesInput.value.trim(),
                    length: lengthInput.value ? parseFloat(lengthInput.value) : null,
                    weight: weightInput.value ? parseFloat(lengthInput.value) : null,
                    datetime: datetimeInput.value,
                    notes: notesInput.value.trim(),
                    latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                    longitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                    locationName: locationNameInput.value.trim() || null,
                    photo: null
                });
                saveCatchToIndexedDB(newCatch);
            }
        }


        async function deleteCatch(id) {
            if (!confirm('Are you sure you want to delete this catch?')) {
                return;
            }

            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('FishingLogDB', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });

                const transaction = db.transaction('catches', 'readwrite');
                const store = transaction.objectStore('catches');
                
                await new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });

                closeCatchModal();
                renderCatches();
                showMessage('Catch deleted successfully!', 'success');
            } catch (error) {
                console.error('Delete failed:', error);
                showMessage('Failed to delete catch. Please try again.', 'error');
            }
        }


        function clearAllLogs() {
            const confirmation = confirm("Are you sure you want to delete ALL logged catches? This cannot be undone.");
            if (confirmation) {
                const request = indexedDB.open('FishingLogDB', 1);

                request.onsuccess = function (event) {
                    const db = event.target.result;
                    const transaction = db.transaction('catches', 'readwrite');
                    const store = transaction.objectStore('catches');
                    const clearRequest = store.clear();

                    clearRequest.onsuccess = function () {
                        renderCatches(); // Refresh the UI
                        showMessage('All catches cleared.', 'success');
                    };

                    clearRequest.onerror = function (event) {
                        console.error('Failed to clear logs:', event.target.error);
                        showMessage('Failed to clear logs. Please try again.', 'error');
                    };
                };
            }
        }


        // --- Rendering ---
        function showLoading() {
            document.getElementById('loading-indicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        function renderCatchesUI(catches) {
            catchLogContainer.innerHTML = '';

            if (catches.length === 0) {
                catchLogContainer.innerHTML = '<p class="text-gray-500 italic">No catches logged yet.</p>';
                return;
            }

            catches.forEach(c => {
                const catchElement = document.createElement('div');
                catchElement.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white relative hover:shadow-md transition-shadow duration-150 cursor-pointer flex justify-between items-center gap-4';

                const textContent = document.createElement('div');
                textContent.className = 'flex-grow min-w-0'; // min-w-0 prevents text overflow
                textContent.innerHTML = `
                    <h3 class="text-lg font-semibold text-blue-700 truncate">${c.species || 'Unknown Species'}</h3>
                    <p class="text-sm text-gray-500"><strong>Date:</strong> ${formatDate(new Date(c.datetime))}</p>
                    ${c.locationName ? `<p class="text-sm text-gray-500 truncate">${c.locationName}</p>` : ''}
                `;

                catchElement.appendChild(textContent);

                if (c.photo) {
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'flex-shrink-0 w-24 h-24 overflow-hidden rounded-md shadow-sm';
                    imagePreview.innerHTML = `
                        <img src="${c.photo}" alt="Catch preview" class="w-full h-full object-cover hover:opacity-90 transition-opacity">
                    `;
                    catchElement.appendChild(imagePreview);
                }

                catchElement.addEventListener('click', () => {
                    openCatchModal(c);
                });

                catchLogContainer.appendChild(catchElement);
            });
        }

        function renderCatches(page = 0) {
            const request = indexedDB.open('FishingLogDB', 1);

            request.onsuccess = function (event) {
                const db = event.target.result;
                const transaction = db.transaction('catches', 'readonly');
                const store = transaction.objectStore('catches');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function () {
                    const catches = getAllRequest.result;
                    const totalPages = Math.ceil(catches.length / itemsPerPage);
                    const start = page * itemsPerPage;
                    const end = start + itemsPerPage;
                    const paginatedCatches = catches.slice(start, end);

                    renderCatchesUI(paginatedCatches);

                    // Show/hide pagination controls based on total catches
                    const paginationControls = document.getElementById('pagination-controls');
                    if (catches.length > itemsPerPage) {
                        paginationControls.classList.remove('hidden');
                        paginationControls.classList.add('flex');
                        document.getElementById('prev-page-btn').disabled = page === 0;
                        document.getElementById('next-page-btn').disabled = page >= totalPages - 1;
                    } else {
                        paginationControls.classList.remove('flex');
                        paginationControls.classList.add('hidden');
                    }
                };
            };
        }

        // Event listeners for pagination buttons
        document.getElementById('prev-page-btn').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                renderCatches(currentPage);
            }
        });

        document.getElementById('next-page-btn').addEventListener('click', () => {
            currentPage++;
            renderCatches(currentPage);
        });

        function openCatchModal(catchData) {
            const modal = document.getElementById('catch-modal');
            const modalSpecies = document.getElementById('modal-species');
            const modalDate = document.getElementById('modal-date');
            const modalLength = document.getElementById('modal-length');
            const modalWeight = document.getElementById('modal-weight');
            const modalLocationName = document.getElementById('modal-location-name');
            const modalNotes = document.getElementById('modal-notes');
            const modalPhoto = document.getElementById('modal-photo');
            const modalPhotoContainer = document.getElementById('modal-photo-container');
            const deleteCatchBtn = document.getElementById('delete-catch-btn');
            const editCatchBtn = document.getElementById('edit-catch-btn');

            // Populate modal with catch data
            modalSpecies.textContent = catchData.species || 'Unknown Species';
            modalDate.textContent = formatDate(new Date(catchData.datetime));
            
            modalLength.textContent = catchData.length ? `Length: ${catchData.length} cm` : '';
            modalWeight.textContent = catchData.weight ? `Weight: ${catchData.weight} kg` : '';
            
            // Handle location display - make location name clickable
            if (catchData.latitude && catchData.longitude) {
                const mapUrl = `https://www.google.com/maps?q=${catchData.latitude},${catchData.longitude}`;
                if (catchData.locationName) {
                    modalLocationName.textContent = catchData.locationName;
                    modalLocationName.href = mapUrl;
                    modalLocationName.classList.remove('hidden');
                } else {
                    modalLocationName.classList.add('hidden');
                }
            } else {
                if (catchData.locationName) {
                    modalLocationName.textContent = catchData.locationName;
                    modalLocationName.removeAttribute('href');
                    modalLocationName.classList.remove('hidden');
                } else {
                    modalLocationName.classList.add('hidden');
                }
            }

            modalNotes.textContent = catchData.notes || '';

            if (catchData.photo) {
                modalPhoto.src = catchData.photo;
                modalPhotoContainer.classList.remove('hidden');
                
                modalPhoto.onclick = (e) => {
                    e.stopPropagation(); // Prevent modal close
                    openFullscreenImage(catchData.photo);
                };
            } else {
                modalPhotoContainer.classList.add('hidden');
            }

            deleteCatchBtn.onclick = () => deleteCatch(catchData.id);
            editCatchBtn.onclick = () => openEditModal(catchData);
            modal.classList.remove('hidden');
        }

        function openEditModal(catchData) {
            const editModal = document.getElementById('edit-modal');
            const editSpecies = document.getElementById('edit-species');
            const editLength = document.getElementById('edit-length');
            const editWeight = document.getElementById('edit-weight');
            const editDatetime = document.getElementById('edit-datetime');
            const editLocationName = document.getElementById('edit-location-name');
            const editNotes = document.getElementById('edit-notes');
            const editCatchId = document.getElementById('edit-catch-id');
            const editLatitude = document.getElementById('edit-latitude');
            const editLongitude = document.getElementById('edit-longitude');
            const editPhoto = document.getElementById('edit-photo');
            const editPhotoInput = document.getElementById('edit-photo-input');
            const editPhotoBtn = document.getElementById('edit-photo-btn');
            const editPhotoText = document.getElementById('edit-photo-text');

            // Populate edit form with catch data
            editSpecies.value = catchData.species || '';
            editLength.value = catchData.length || '';
            editWeight.value = catchData.weight || '';
            editDatetime.value = catchData.datetime;
            editLocationName.value = catchData.locationName || '';
            editNotes.value = catchData.notes || '';
            editCatchId.value = catchData.id;
            editLatitude.value = catchData.latitude || '';
            editLongitude.value = catchData.longitude || '';
            editPhoto.value = catchData.photo || '';

            // Update photo button text based on whether there's an existing photo
            editPhotoText.textContent = catchData.photo ? 'Change Photo' : 'Add Photo';
            
            // Handle photo button click
            editPhotoBtn.onclick = () => {
                editPhotoInput.click();
            };

            // Handle file selection
            editPhotoInput.onchange = () => {
                const file = editPhotoInput.files[0];
                if (file) {
                    editPhotoText.textContent = '✓ New photo selected';
                    editPhotoBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                    editPhotoBtn.classList.add('bg-green-100', 'hover:bg-green-200', 'text-green-700');
                } else {
                    editPhotoText.textContent = catchData.photo ? 'Change Photo' : 'Add Photo';
                    editPhotoBtn.classList.remove('bg-green-100', 'hover:bg-green-200', 'text-green-700');
                    editPhotoBtn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                }
            };

            editModal.classList.remove('hidden');
        }

        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.closest('.bg-white')) return;
            document.getElementById('edit-modal').classList.add('hidden');
        });

        function closeFullscreenImage() {
            const fullscreen = document.getElementById('fullscreen-image');
            fullscreen.classList.add('hidden');
        }

        function openFullscreenImage(src) {
            const fullscreen = document.getElementById('fullscreen-image');
            const img = document.getElementById('fullscreen-image-content');
            img.src = src;
            fullscreen.classList.remove('hidden');
            
            // Prevent modal close when clicking the image
            img.onclick = (e) => {
                e.stopPropagation();
            };

            // Enable closing when clicking outside the image
            fullscreen.onclick = () => {
                closeFullscreenImage();
            };
        }

        // Add click handlers for fullscreen image view
        document.getElementById('fullscreen-image').addEventListener('click', function(e) {
            if (e.target === this || e.target.tagName === 'BUTTON') {
                closeFullscreenImage();
            }
        });

        // Prevent click propagation from image
        document.getElementById('fullscreen-image-content').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Update modal close handling
        document.getElementById('catch-modal').addEventListener('click', (e) => {
            if (e.target.closest('.bg-white')) return; // Click inside modal content
            closeCatchModal();
        });

        document.getElementById('close-modal-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeCatchModal();
        });

        document.getElementById('close-edit-modal-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('edit-modal').classList.add('hidden');
        });

        function closeCatchModal() {
            const modal = document.getElementById('catch-modal');
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = ''; // Restore background scrolling
        }

        // Handle escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeCatchModal();
                document.getElementById('edit-modal').classList.add('hidden');
            }
        });

        function resizeImage(file, maxWidth, maxHeight, callback) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        if (width > height) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        } else {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    callback(canvas.toDataURL('image/jpeg', 0.8)); // Adjust quality as needed
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function openFullImage(src) {
            const fullscreen = document.getElementById('fullscreen-image');
            const img = fullscreen.querySelector('img');
            img.src = src;
            
            img.onload = function() {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const imageRatio = this.naturalWidth / this.naturalHeight;
                
                // Reset styles
                this.style = '';
                this.style.position = 'absolute';
                
                if (imageRatio < 1) { // Portrait image
                    // Use 80% of viewport for better display
                    const maxDimension = Math.min(viewportWidth, viewportHeight) * 0.8;
                    const scale = maxDimension / this.naturalHeight;
                    
                    // Set dimensions for rotation
                    const rotatedWidth = this.naturalHeight * scale;
                    const rotatedHeight = this.naturalWidth * scale;
                    
                    // Position the image
                    this.style.width = rotatedWidth + 'px';
                    this.style.height = rotatedHeight + 'px';
                    
                    // Center using CSS transform
                    this.style.top = '50%';
                    this.style.left = '50%';
                    this.style.transform = 'translate(-50%, -50%) rotate(90deg)';
                } else {
                    // Landscape images
                    const scale = Math.min(
                        (viewportWidth * 0.8) / this.naturalWidth,
                        (viewportHeight * 0.8) / this.naturalHeight
                    );
                    
                    this.style.width = (this.naturalWidth * scale) + 'px';
                    this.style.height = (this.naturalHeight * scale) + 'px';
                    this.style.left = '50%';
                    this.style.top = '50%';
                    this.style.transform = 'translate(-50%, -50%)';
                }
            };
            
            fullscreen.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        document.getElementById('fullscreen-image').addEventListener('click', function() {
            this.classList.add('hidden');
            document.body.style.overflow = '';
        });

        function createCatchObject(data) {
            return {
                id: Date.now().toString(),
                species: data.species,
                length: data.length,
                weight: data.weight,
                datetime: data.datetime,
                notes: data.notes,
                latitude: data.latitude,
                longitude: data.longitude,
                locationName: data.locationName,
                photo: data.photo
            };
        }

        function saveCatchToIndexedDB(newCatch) {
            if (!newCatch.species || !newCatch.datetime) {
                showMessage("Species and Date/Time are required.", 'error');
                return;
            }

            const request = indexedDB.open('FishingLogDB', 1);
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction('catches', 'readwrite');
                const store = transaction.objectStore('catches');
                
                store.add(newCatch);

                transaction.oncomplete = function() {
                    renderCatches();
                    catchForm.reset();
                    setDefaultDateTime();
                    latitudeInput.value = '';
                    longitudeInput.value = '';
                    locationStatus.textContent = 'Location not saved.';
                    locationStatus.classList.remove('text-green-600', 'text-red-600');
                    showMessage('Catch logged successfully!', 'success');
                };

                transaction.onerror = function(event) {
                    console.error('Failed to save catch:', event.target.error);
                    showMessage('Failed to save catch. Please try again.', 'error');
                };
            };

            request.onerror = function(event) {
                console.error('Failed to open IndexedDB:', event.target.error);
                showMessage('Database error. Please try again.', 'error');
            };
        }

        // Add length-weight calculation functionality
        lengthInput.addEventListener('input', function() {
            const species = speciesInput.value;
            const length = parseFloat(this.value);
            
            if (species && length && fishSpeciesData[species]) {
                const weightRange = getWeightRange(species, length);
                if (weightRange) {
                    const weightTip = document.createElement('div');
                    weightTip.className = 'text-sm text-gray-600 mt-1';
                    weightTip.textContent = `Expected weight: ${weightRange.expected}kg (${weightRange.min}-${weightRange.max}kg)`;
                    
                    // Update or add the weight tip
                    const existingTip = weightInput.parentElement.querySelector('.weight-tip');
                    if (existingTip) {
                        existingTip.replaceWith(weightTip);
                    } else {
                        weightInput.parentElement.appendChild(weightTip);
                    }
                    weightTip.classList.add('weight-tip');
                }
            } else {
                // Remove existing weight tip if present
                const existingTip = weightInput.parentElement.querySelector('.weight-tip');
                if (existingTip) {
                    existingTip.remove();
                }
            }
        });

        // Validate weight against expected range
        weightInput.addEventListener('input', function() {
            const species = speciesInput.value;
            const length = parseFloat(lengthInput.value);
            const weight = parseFloat(this.value);
            
            if (species && length && weight && fishSpeciesData[species]) {
                const weightRange = getWeightRange(species, length);
                if (weightRange) {
                    const isWithinRange = weight >= weightRange.min && weight <= weightRange.max;
                    
                    // Add visual feedback
                    if (!isWithinRange) {
                        this.classList.add('border-yellow-400');
                        
                        // Show warning message
                        let warningEl = this.parentElement.querySelector('.weight-warning');
                        if (!warningEl) {
                            warningEl = document.createElement('div');
                            warningEl.className = 'text-sm text-yellow-600 mt-1 weight-warning';
                            this.parentElement.appendChild(warningEl);
                        }
                        warningEl.textContent = `Warning: Weight seems unusual for this species and length`;
                    } else {
                        this.classList.remove('border-yellow-400');
                        const warningEl = this.parentElement.querySelector('.weight-warning');
                        if (warningEl) warningEl.remove();
                    }
                }
            } else {
                this.classList.remove('border-yellow-400');
                const warningEl = this.parentElement.querySelector('.weight-warning');
                if (warningEl) warningEl.remove();
            }
        });

        // Add species length range validation
        function validateSpeciesLength(species, length) {
            const data = fishSpeciesData[species];
            if (!data || !length) return null;
            
            if (length < data.minLength || length > data.maxLength) {
                return {
                    isValid: false,
                    message: `Typical length range for ${species}: ${data.minLength}-${data.maxLength}cm`
                };
            }
            
            return { isValid: true };
        }

        // Add length validation to length input
        lengthInput.addEventListener('input', function() {
            const species = speciesInput.value;
            const length = parseFloat(this.value);
            
            if (species && length && fishSpeciesData[species]) {
                const validation = validateSpeciesLength(species, length);
                if (!validation.isValid) {
                    this.classList.add('border-yellow-400');
                    
                    // Show warning message
                    let warningEl = this.parentElement.querySelector('.length-warning');
                    if (!warningEl) {
                        warningEl = document.createElement('div');
                        warningEl.className = 'text-sm text-yellow-600 mt-1 length-warning';
                        this.parentElement.appendChild(warningEl);
                    }
                    warningEl.textContent = validation.message;
                } else {
                    this.classList.remove('border-yellow-400');
                    const warningEl = this.parentElement.querySelector('.length-warning');
                    if (warningEl) warningEl.remove();
                }
            } else {
                this.classList.remove('border-yellow-400');
                const warningEl = this.parentElement.querySelector('.length-warning');
                if (warningEl) warningEl.remove();
            }
        });

        function setupSpeciesInput() {
            const speciesInput = document.getElementById('species');
            const dropdown = document.getElementById('species-dropdown');
            const manageBtn = document.getElementById('manage-species-btn');
            
            // Setup species search with length-weight info
            speciesInput.addEventListener('input', debounce(() => {
                const query = speciesInput.value.trim().toLowerCase();
                if (query.length < 1) {
                    dropdown.classList.add('hidden');
                    return;
                }

                const matches = predefinedSpecies.filter(s => 
                    s.toLowerCase().includes(query)
                ).sort((a, b) => a.localeCompare(b));

                renderSpeciesDropdown(matches, query);
            }, 200));

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!speciesInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Setup manage species button
            manageBtn.addEventListener('click', openManageSpeciesModal);
        }

        function renderSpeciesDropdown(matches, query) {
            const dropdown = document.getElementById('species-dropdown');
            dropdown.innerHTML = '';

            if (matches.length === 0) {
                const addNew = document.createElement('div');
                addNew.className = 'p-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2';
                addNew.innerHTML = `
                    <span class="text-green-600">+</span>
                    <span>Add "${query}" as custom species</span>
                `;
                addNew.onclick = () => openAddSpeciesModal(query);
                dropdown.appendChild(addNew);
            } else {
                matches.forEach(species => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    
                    // Add species info if available
                    const data = fishSpeciesData[species];
                    const infoText = data ? 
                        `(${data.minLength}-${data.maxLength}cm)` : 
                        '(Custom species)';
                    
                    div.innerHTML = `
                        <div class="font-medium">${species}</div>
                        <div class="text-xs text-gray-500">${infoText}</div>
                    `;
                    
                    div.onclick = () => {
                        document.getElementById('species').value = species;
                        dropdown.classList.add('hidden');
                        
                        // Clear length/weight warnings
                        const lengthWarning = document.querySelector('.length-warning');
                        const weightWarning = document.querySelector('.weight-warning');
                        if (lengthWarning) lengthWarning.remove();
                        if (weightWarning) weightWarning.remove();
                        
                        // Trigger length validation if length is already entered
                        const length = parseFloat(document.getElementById('length').value);
                        if (length) {
                            lengthInput.dispatchEvent(new Event('input'));
                        }
                    };
                    dropdown.appendChild(div);
                });
            }

            dropdown.classList.remove('hidden');
        }

        // Initialize species management
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize IndexedDB
            const request = indexedDB.open('FishingLogDB', 2);
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('catches')) {
                    db.createObjectStore('catches', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('species')) {
                    const speciesStore = db.createObjectStore('species', { keyPath: 'name' });
                    // Add predefined species
                    predefinedSpecies.forEach(species => {
                        speciesStore.add({ name: species, isPredefined: true });
                    });
                }
            };
            
            request.onsuccess = function(event) {
                console.log('IndexedDB initialized successfully');
            };
            
            request.onerror = function(event) {
                console.error('Failed to initialize IndexedDB:', event.target.error);
                showMessage('Database error. Please refresh the page.', 'error');
            };

            // Set up enter app button handlers
            const enterAppBtn = document.getElementById('enter-app-btn');
            enterAppBtn.addEventListener('click', showApp);
            document.getElementById('back-to-landing-btn').addEventListener('click', showLandingPage);
            
            // Set default date/time
            setDefaultDateTime();
            
            // Initialize species management
            setupSpeciesInput();
            
            // Check if we should show the app view
            if (window.location.hash === '#app') {
                showApp();
            }
        });
    </script>

</body>
</html>
